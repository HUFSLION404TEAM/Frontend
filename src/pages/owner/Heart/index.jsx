// src/pages/owner/Heart/index.jsx
import React from "react";
import BackIconSrc from "../../../assets/Back.svg";
import SearchIconSrc from "../../../assets/Search.svg";
import HomeIconSrc from "../../../assets/Home.svg";
import HeartIconSrc from "../../../assets/Heart.svg";
import EmptyHeartSrc from "../../../assets/emptyHeart.svg";
import TemperatureIconSrc from "../../../assets/Temperature.svg";
import { useNavigate } from "react-router-dom";

// üîó Ïó∞Îèô Ï∂îÍ∞Ä
import { listHearts } from "../../../api/heart";
import { useHeart } from "../../../contexts/heartcontext";

const STATUS_H = 59;
const HEADER_H = 49;
const HEADER_PAD_L = 20;

// üîµ Ï§ëÍ∞Ñ ÏòÅÏó≠(ÌÜ†Í∏ÄÎßå) ‚Äî Í∏∞Ï°¥ Î†àÏù¥ÏïÑÏõÉ Ïú†ÏßÄ
const MID_H = 86;

/* ================= Í≥µÌÜµ ÌîÑÎ†àÏûÑ ================= */
const containerStyle = {
  overflow: "auto",
  display: "flex",
  justifyContent: "center",
  alignItems: "center",
  minHeight: "100vh",
  backgroundColor: "#f0f0f0",
};
const frameStyle = {
  width: 390,
  height: 844,
  backgroundColor: "#FFFFFF",
  border: "1px solid #000000",
  boxSizing: "border-box",
  position: "relative",
  overflow: "hidden",
};
const statusBarStyle = {
  position: "absolute",
  top: 0,
  left: 0,
  right: 0,
  height: STATUS_H,
  backgroundColor: "#FFDDE4",
  zIndex: 1,
};
const topFrameStyle = {
  position: "absolute",
  top: STATUS_H,
  left: 0,
  right: 0,
  height: HEADER_H,
  padding: "0 20px 10px 20px",
  borderBottom: "1px solid #EEE",
  background: "#FFF",
  boxSizing: "border-box",
  zIndex: 2,
  display: "block",
};

/* ================= Ìó§Îçî(ÌÅ¥Î¶≠ Ìï∏Îì§Îü¨ Î∞õÎäî ÌòïÌÉú) ================= */
const BackIcon = (onclick) => (
  <img
    src={BackIconSrc}
    alt="Îí§Î°úÍ∞ÄÍ∏∞"
    width={28}
    height={28}
    style={{
      position: "absolute",
      top: "50%",
      left: HEADER_PAD_L,
      transform: "translateY(-50%)",
      cursor: "pointer",
    }}
    onClick={onclick}
  />
);
const SearchIcon = (onclick) => (
  <img
    src={SearchIconSrc}
    alt="Í≤ÄÏÉâ"
    width={24}
    height={24}
    style={{
      position: "absolute",
      top: "50%",
      left: 317,
      transform: "translateY(-50%)",
      cursor: "pointer",
    }}
    onClick={onclick}
  />
);
const HomeIcon = (onclick) => (
  <img
    src={HomeIconSrc}
    alt="Ìôà"
    width={24}
    height={24}
    style={{
      position: "absolute",
      top: "50%",
      left: 346,
      transform: "translateY(-50%)",
      cursor: "pointer",
    }}
    onClick={onclick}
  />
);
const Title = (
  <div
    style={{
      position: "absolute",
      top: "50%",
      left: "50%",
      transform: "translate(-50%, -50%)",
      color: "#000",
      fontSize: 20,
      fontWeight: 700,
      lineHeight: "28px",
      letterSpacing: "-0.5px",
      whiteSpace: "nowrap",
    }}
  >
    Í¥ÄÏã¨Î™©Î°ù
  </div>
);

/* ================= Ï§ëÍ∞Ñ ÏòÅÏó≠(ÌÜ†Í∏ÄÎßå) ================= */
const midAreaStyle = {
  position: "absolute",
  top: STATUS_H + HEADER_H,
  left: 0,
  right: 0,
  height: MID_H,
  padding: 10,
  background: "#FFF",
  boxSizing: "border-box",
  display: "flex",
  flexDirection: "column",
  gap: 10,
};
const toggleRowStyle = {
  display: "flex",
  justifyContent: "flex-end",
  alignItems: "center",
  gap: 5,
  borderBottom: "1px solid #EEE",
  paddingBottom: 10,
};
const toggleStyleBase = {
  position: "relative",
  width: 44,
  height: 24,
  borderRadius: 12,
  cursor: "pointer",
};
const toggleKnobBase = {
  position: "absolute",
  top: 2,
  width: 20,
  height: 20,
  borderRadius: "50%",
  background: "#FFF",
  boxShadow: "0 1px 3px rgba(0,0,0,0.2)",
  transition: "left .18s, right .18s, transform .18s",
};
const toggleLabelStyle = { fontSize: 12, color: "#000" };

/* ================= Î¶¨Ïä§Ìä∏ ================= */
const listContainerStyle = {
  position: "absolute",
  top: STATUS_H + HEADER_H + MID_H - 30,
  bottom: 0,
  left: "50%",
  transform: "translateX(-50%)",
  width: 348,
  display: "flex",
  flexDirection: "column",
  gap: 10,
  overflowY: "auto",
};

const bizCardStyle = {
  position: "relative",
  display: "flex",
  alignItems: "center",
  gap: 20,
  minHeight: 96,
  padding: 12,
  borderRadius: 16,
  background: "#FFF",
  boxShadow: "0 1px 2px rgba(0,0,0,0.03), 0 6px 20px rgba(0,0,0,0.04)",
  boxSizing: "border-box",
  cursor: "pointer",
};
const avatarStyle = {
  width: 60,
  height: 60,
  borderRadius: "50%",
  background: "#C9CED6",
  flex: "0 0 60px",
};
const bizTextWrap = {
  display: "flex",
  flexDirection: "column",
  gap: 6,
  flex: 1,
  minWidth: 0,
};
const bizTitle = {
  fontSize: 18,
  fontWeight: 700,
  color: "#111",
  letterSpacing: "-0.5px",
};
const bizMeta = { fontSize: 13, color: "#767676" };
const tempRow = {
  display: "flex",
  alignItems: "center",
  gap: 6,
  fontSize: 12,
  color: "#767676",
};
const heartAbs = {
  position: "absolute",
  top: 12,
  right: 12,
  width: 24,
  height: 24,
  cursor: "pointer",
};

/* ================== Í≤ÄÏÉâ ÌåùÏóÖ ================== */
const searchPopupStyle = {
  position: "absolute",
  top: STATUS_H + HEADER_H + 6,
  left: "50%",
  transform: "translateX(-50%)",
  width: 348,
  height: 44,
  background: "#FFF",
  border: "none",
  borderRadius: "10px",
  boxShadow: "0 6px 16px rgba(0,0,0,0.12)",
  display: "flex",
  alignItems: "center",
  padding: "0 12px",
  boxSizing: "border-box",
  zIndex: 4,
  outline: "none",
};
const backdropStyle = {
  position: "absolute",
  top: 0,
  left: 0,
  right: 0,
  bottom: 0,
  zIndex: 3,
};
const searchInputStyle = {
  flex: 1,
  height: "100%",
  border: "none",
  outline: "none",
  fontSize: 14,
};

/* ================= Ïπ¥Îìú Ïª¥Ìè¨ÎÑåÌä∏ ================= */
function BizCard({
  title,
  region = "Ïö©Ïù∏Ïãú Í∏∞Ìù•Íµ¨",
  posts = "0Í±¥",
  status = "Íµ¨ÏßÅ Ï§ë",
  temp = "36.5¬∞C",
  liked = false,
  onToggleHeart,
  onOpen,
}) {
  return (
    <div style={bizCardStyle} onClick={onOpen}>
      <div style={avatarStyle} />
      <div style={bizTextWrap}>
        <div style={bizTitle}>{title}</div>
        <div style={bizMeta}>
          {region} ¬∑ {posts} ¬∑ {status}
        </div>
        <div style={tempRow}>
          <img src={TemperatureIconSrc} alt="Ïò®ÎèÑ" width={12} height={12} />
          <span>{temp}</span>
        </div>
      </div>
      <img
        src={liked ? HeartIconSrc : EmptyHeartSrc}
        alt="Ï∞ú"
        style={heartAbs}
        onClick={(e) => {
          e.stopPropagation(); // Ïπ¥Îìú Ïù¥Îèô ÎßâÍ≥† ÌïòÌä∏Îßå ÌÜ†Í∏Ä
          onToggleHeart?.();
        }}
      />
    </div>
  );
}

/* ================= ÌéòÏù¥ÏßÄ ================= */
export default function HeartOwner() {
  const navigate = useNavigate();

  // üîó Ï∞ú ÌÉÄÏûÖ: ÏÜåÏÉÅÍ≥µÏù∏Ïù¥ Ï∞úÌïú ÎåÄÏÉÅÏùÄ 'ÎåÄÌïôÏÉù(Í∏∞ÌöçÏûê)'
  const HEART_TYPE = "planner";

  // ÏÑúÎ≤Ñ Î™©Î°ù/ÏÉÅÌÉú
  const [items, setItems] = React.useState([]);
  const [loading, setLoading] = React.useState(false);
  const [error, setError] = React.useState(null);
  const { toggle } = useHeart();

  // Íµ¨ÏßÅ Ï§ëÎßå Î≥¥Í∏∞ ÌÜ†Í∏Ä
  const [onlyActive, setOnlyActive] = React.useState(true);

  // Í≤ÄÏÉâ ÌåùÏóÖ
  const [searchOpen, setSearchOpen] = React.useState(false);
  const [q, setQ] = React.useState("");

  // ÏÑúÎ≤Ñ ÏùëÎãµ ‚Üí Ïπ¥ÎìúÏö© Îç∞Ïù¥ÌÑ∞ Îß§Ìïë
  function mapToCard(x) {
    const title = x?.title || x?.name || x?.nickname || "Ïù¥Î¶Ñ";
    const status = x?.status || "Íµ¨ÏßÅ Ï§ë";
    const region = x?.region || x?.location || "ÏßÄÏó≠";
    const posts =
      typeof x?.posts === "number"
        ? `${x.posts}Í±¥`
        : typeof x?.openings === "number"
        ? `${x.openings}Í±¥`
        : "0Í±¥";
    const temp =
      typeof x?.temperature === "number"
        ? `${x.temperature.toFixed(1)}¬∞C`
        : x?.temp || "36.5¬∞C";

    return {
      id: x?.id ?? x?.targetId ?? crypto.randomUUID(),
      title,
      status,
      region,
      posts,
      temp,
    };
  }

  // Ï∞ú Î™©Î°ù Ï°∞Ìöå
  async function fetchHearts() {
    try {
      setLoading(true);
      setError(null);
      const res = await listHearts(HEART_TYPE);
      const arr = Array.isArray(res?.items)
        ? res.items
        : Array.isArray(res)
        ? res
        : Array.isArray(res?.content)
        ? res.content
        : [];
      setItems(arr.map(mapToCard));
    } catch (e) {
      console.error(e);
      setError(e.message || "ÏóêÎü¨");
      setItems([]);
    } finally {
      setLoading(false);
    }
  }

  // ÏµúÏ¥à Î°úÎìú
  React.useEffect(() => {
    fetchHearts();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // ÌïòÌä∏ ÌÜ†Í∏Ä ‚Üí ÏÑúÎ≤Ñ ÏóÖÎç∞Ïù¥Ìä∏ ÌõÑ ÌôîÎ©¥ÏóêÏÑú Ìï¥Îãπ Ïπ¥Îìú Ï†úÍ±∞
  async function onToggleHeart(id) {
    try {
      await toggle(HEART_TYPE, id);
      setItems((prev) => prev.filter((it) => it.id !== id));
    } catch (e) {
      // Ïã§Ìå® Ïãú Î¨¥Ïãú(ÌïÑÏöîÏãú ÏïåÎ¶º)
    }
  }

  // ÌïÑÌÑ∞ÎßÅ(Íµ¨ÏßÅ Ï§ëÎßå Î≥¥Í∏∞ + Í≤ÄÏÉâ)
  const filtered = (
    onlyActive ? items.filter((it) => it.status === "Íµ¨ÏßÅ Ï§ë") : items
  ).filter((it) =>
    (it.title || "").toLowerCase().includes(q.trim().toLowerCase())
  );

  return (
    <div style={containerStyle}>
      <div style={frameStyle}>
        {/* StatusBar */}
        <div style={statusBarStyle} />

        {/* Header */}
        <div style={topFrameStyle}>
          {BackIcon(() => {
            navigate("/owner/dash");
          })}
          {Title}
          {SearchIcon(() => setSearchOpen(true))}
          {HomeIcon(() => navigate("/owner/dash"))}
        </div>

        {/* üîç Í≤ÄÏÉâ ÌåùÏóÖ */}
        {searchOpen && (
          <>
            <div style={backdropStyle} onClick={() => setSearchOpen(false)} />
            <div style={searchPopupStyle}>
              <input
                type="text"
                placeholder="Ïù¥Î¶ÑÏúºÎ°ú Í≤ÄÏÉâ"
                value={q}
                onChange={(e) => setQ(e.target.value)}
                style={searchInputStyle}
                autoFocus
                onKeyDown={(e) => {
                  if (e.key === "Escape") setSearchOpen(false);
                  if (e.key === "Enter") setSearchOpen(false);
                }}
              />
              <img
                src={SearchIconSrc}
                alt="Í≤ÄÏÉâ Ïã§Ìñâ"
                width={20}
                height={20}
                style={{ marginLeft: 8, cursor: "pointer" }}
                onClick={() => setSearchOpen(false)}
              />
            </div>
          </>
        )}

        {/* Ï§ëÍ∞Ñ ÏòÅÏó≠: ÌÜ†Í∏ÄÎßå Ïú†ÏßÄ */}
        <div style={midAreaStyle}>
          <div style={toggleRowStyle}>
            <div
              style={{
                ...toggleStyleBase,
                background: onlyActive ? "#0080FFCC" : "#DADDE1",
                transition: "background-color .18s",
              }}
              onClick={() => setOnlyActive((v) => !v)}
            >
              <div
                style={{
                  ...toggleKnobBase,
                  right: onlyActive ? 2 : "auto",
                  left: onlyActive ? "auto" : 2,
                }}
              />
            </div>
            <span style={toggleLabelStyle}>Íµ¨ÏßÅ Ï§ëÎßå Î≥¥Í∏∞</span>
          </div>
        </div>

        {/* Î¶¨Ïä§Ìä∏ */}
        <div style={listContainerStyle}>
          {/* ÏÉÅÌÉú Î©îÏãúÏßÄ */}
          {loading && (
            <div style={{ fontSize: 12, color: "#767676" }}>Î∂àÎü¨Ïò§Îäî Ï§ë‚Ä¶</div>
          )}
          {error && !loading && (
            <div style={{ fontSize: 12, color: "#D00" }}>
              Í¥ÄÏã¨Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.
            </div>
          )}

          {filtered.map((it) => (
            <BizCard
              key={it.id}
              title={it.title}
              region={it.region}
              posts={it.posts}
              status={it.status}
              temp={it.temp}
              liked={true} // Ï∞ú Î™©Î°ù ÌôîÎ©¥Ïù¥ÎØÄÎ°ú Í∏∞Î≥∏ true
              onToggleHeart={() => onToggleHeart(it.id)}
              onOpen={() =>
                navigate("/owner/Detail", {
                  state: { name: it.title, status: it.status, id: it.id },
                })
              }
            />
          ))}
        </div>
      </div>
    </div>
  );
}
